name: Mobile VPN via Tailscale

on:
  workflow_dispatch:  # Permite ejecuci√≥n manual

jobs:
  mobile-vpn:
    runs-on: windows-latest
    timeout-minutes: 15  # 15 minutos m√°ximo (10 + margen)

    steps:
    - name: Install Tailscale
      run: |
        # Descargar e instalar Tailscale
        $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
        $installerPath = "$env:TEMP\tailscale.msi"
        
        Write-Host "üì• Descargando Tailscale..."
        Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
        
        Write-Host "üîß Instalando Tailscale..."
        Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
        Remove-Item $installerPath -Force
        Write-Host "‚úÖ Tailscale instalado"

    - name: Configure Tailscale as Exit Node
      run: |
        Write-Host "üîó Conectando a Tailscale..."
        
        # Conectar a Tailscale y anunciarse como Exit Node
        & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-vpn-$env:GITHUB_RUN_ID --advertise-exit-node --accept-routes
        
        Write-Host "‚úÖ Autenticaci√≥n y anuncio como Exit Node completado"
        
        # Esperar y obtener IP con reintentos
        Write-Host "‚è≥ Esperando asignaci√≥n de IP..."
        $tsIP = $null
        $retries = 0
        $maxRetries = 12  # 60 segundos m√°ximo
        
        while (-not $tsIP -and $retries -lt $maxRetries) {
            Start-Sleep -Seconds 5
            $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4 2>$null
            $retries++
            Write-Host "Intento $retries/$maxRetries - IP: $tsIP"
        }
        
        if (-not $tsIP) {
            Write-Host "‚ùå No se pudo obtener IP de Tailscale despu√©s de $maxRetries intentos"
            Write-Host "üìã Estado de Tailscale:"
            & "$env:ProgramFiles\Tailscale\tailscale.exe" status
            exit 1
        }
        
        # Obtener hostname
        $tsHostname = & "$env:ProgramFiles\Tailscale\tailscale.exe" status | Select-String -Pattern "gh-vpn-" | ForEach-Object { $_.Line.Split()[0] }
        
        if (-not $tsHostname) {
            $tsHostname = "gh-vpn-$env:GITHUB_RUN_ID"
        }
        
        Write-Host "üéâ Conexi√≥n exitosa!"
        Write-Host "üì° IP de Tailscale: $tsIP"
        Write-Host "üè∑Ô∏è Hostname: $tsHostname"
        Write-Host "üöÄ Anunciado como Exit Node"
        
        # Guardar en variables de entorno
        echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
        echo "TAILSCALE_HOSTNAME=$tsHostname" >> $env:GITHUB_ENV

    - name: Wait for Manual Configuration
      run: |
        Write-Host ""
        Write-Host "‚öôÔ∏è ===== CONFIGURACI√ìN REQUERIDA ====="
        Write-Host "üîó Ve a: https://login.tailscale.com/admin/machines"
        Write-Host "üí° Busca: $env:TAILSCALE_HOSTNAME"
        Write-Host "üîß Haz clic en ‚Ä¢‚Ä¢‚Ä¢ ‚Üí Edit route settings"
        Write-Host "‚úÖ Activa 'Use as exit node'"
        Write-Host ""
        Write-Host "‚è≥ Esperando 2 minutos para que lo configures..."
        Write-Host "======================================"
        
        # Esperar 2 minutos para dar tiempo a configurar
        for ($i = 120; $i -gt 0; $i--) {
            if (($i % 30) -eq 0) {
                Write-Host "Tiempo restante: $i segundos"
            }
            Start-Sleep -Seconds 1
        }

    - name: Verify Exit Node Status
      run: |
        Write-Host "üîç Verificando estado del Exit Node..."
        
        # Verificar IP final
        $finalIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
        $status = & "$env:ProgramFiles\Tailscale\tailscale.exe" status
        
        Write-Host "‚úÖ IP final: $finalIP"
        Write-Host "üìã Estado completo:"
        Write-Host $status
        
        # Verificar si est√° anunciando exit node
        $exitNodeStatus = & "$env:ProgramFiles\Tailscale\tailscale.exe" status --json | ConvertFrom-Json
        $isAdvertisingExitNode = $exitNodeStatus.Self.ExitNodeOption
        
        Write-Host "üéØ Anunciando Exit Node: $isAdvertisingExitNode"
        
        if (-not $finalIP) {
            Write-Host "‚ùå Error: No hay IP asignada"
            exit 1
        }
        
        if (-not $isAdvertisingExitNode) {
            Write-Host "‚ö†Ô∏è  Advertencia: No se est√° anunciando como Exit Node"
        }

    - name: Maintain VPN Connection
      run: |
        Write-Host ""
        Write-Host "üéâ ===== VPN ACTIVA ====="
        Write-Host "üì° IP del servidor: $env:TAILSCALE_IP"
        Write-Host "üè∑Ô∏è Hostname: $env:TAILSCALE_HOSTNAME"
        Write-Host ""
        Write-Host "üì± Para usar en tu celular:"
        Write-Host "1. Abre Tailscale en tu celular"
        Write-Host "2. Mant√©n presionado: $env:TAILSCALE_HOSTNAME"
        Write-Host "3. Selecciona 'Use as Exit Node'"
        Write-Host ""
        Write-Host "‚è∞ Tiempo restante: 10 MINUTOS"
        Write-Host "üõë Se apagar√° autom√°ticamente"
        Write-Host "=========================="
        Write-Host ""
        
        # Mantener el servicio activo por EXACTAMENTE 10 minutos
        $startTime = Get-Date
        $duration = New-TimeSpan -Minutes 10
        $endTime = $startTime + $duration
        
        while ((Get-Date) -lt $endTime) {
            $remaining = $endTime - (Get-Date)
            $minutesRemaining = [math]::Max(0, [math]::Round($remaining.TotalMinutes, 1))
            
            # Verificar IP actual
            $currentIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
            Write-Host "[$(Get-Date)] Tiempo restante: $minutesRemaining min - IP: $currentIP"
            
            # Verificar que Tailscale siga funcionando
            $statusResult = & "$env:ProgramFiles\Tailscale\tailscale.exe" status
            if ($LASTEXITCODE -ne 0) {
                Write-Host "‚ùå Error: Tailscale desconectado"
                exit 1
            }
            
            Start-Sleep -Seconds 30
        }
        
        Write-Host ""
        Write-Host "‚è∞ ===== TIEMPO COMPLETADO ====="
        Write-Host "üõë VPN apag√°ndose autom√°ticamente"
        Write-Host "‚úÖ Los 10 minutos han terminado"
        Write-Host "================================"
