name: Mobile VPN via Tailscale

on:
  workflow_dispatch:  # Permite ejecuciÃ³n manual

jobs:
  mobile-vpn:
    runs-on: windows-latest
    timeout-minutes: 15  # 15 minutos mÃ¡ximo (10 + margen)

    steps:
    - name: Install Tailscale
      run: |
        # Descargar e instalar Tailscale
        $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
        $installerPath = "$env:TEMP\tailscale.msi"
        
        Write-Host "ğŸ“¥ Descargando Tailscale..."
        Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
        
        Write-Host "ğŸ”§ Instalando Tailscale..."
        Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
        Remove-Item $installerPath -Force
        Write-Host "âœ… Tailscale instalado"

    - name: Configure Tailscale as Exit Node
      run: |
        Write-Host "ğŸ”— Conectando a Tailscale..."
        
        # PRIMERO conectarse a Tailscale con hostname
        & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-vpn-$env:GITHUB_RUN_ID --accept-routes
        
        # LUEGO configurar como exit node
        & "$env:ProgramFiles\Tailscale\tailscale.exe" up --exit-node
        
        # Esperar y obtener IP
        Write-Host "â³ Esperando asignaciÃ³n de IP..."
        Start-Sleep -Seconds 15
        
        $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
        $tsHostname = & "$env:ProgramFiles\Tailscale\tailscale.exe" status | Select-String -Pattern "gh-vpn-" | ForEach-Object { $_.Line.Split()[0] }
        
        if (-not $tsIP) {
            Write-Host "âŒ No se pudo obtener IP de Tailscale"
            Write-Host "ğŸ“‹ Estado actual:"
            & "$env:ProgramFiles\Tailscale\tailscale.exe" status
            exit 1
        }
        
        Write-Host "âœ… Conectado a Tailscale"
        Write-Host "ğŸ“¡ IP de Tailscale: $tsIP"
        Write-Host "ğŸ·ï¸ Hostname: $tsHostname"
        
        # Guardar en variables de entorno
        echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
        echo "TAILSCALE_HOSTNAME=$tsHostname" >> $env:GITHUB_ENV

    - name: Enable Exit Node in Admin Panel
      run: |
        Write-Host ""
        Write-Host "âš™ï¸ ===== CONFIGURACIÃ“N REQUERIDA ====="
        Write-Host "ğŸ”— Ve a: https://login.tailscale.com/admin/machines"
        Write-Host "ğŸ’¡ Busca el dispositivo: $env:TAILSCALE_HOSTNAME"
        Write-Host "ğŸ”§ Haz clic en los 3 puntos â†’ Edit route settings"
        Write-Host "âœ… Activa 'Use as exit node'"
        Write-Host "======================================"
        Write-Host ""

    - name: Wait for Manual Configuration
      run: |
        Write-Host "â³ Esperando que actives 'Use as exit node' en el panel..."
        Write-Host "â° Tienes 2 minutos para configurarlo"
        Write-Host "ğŸ“± Mientras tanto, instala Tailscale en tu celular si no lo has hecho"
        
        # Esperar 2 minutos para dar tiempo a configurar
        Start-Sleep -Seconds 120

    - name: Maintain VPN Connection
      run: |
        Write-Host ""
        Write-Host "ğŸ‰ ===== VPN ACTIVA ====="
        Write-Host "ğŸ“± Para usar en tu celular:"
        Write-Host "1. Abre la app Tailscale en tu celular"
        Write-Host "2. MantÃ©n presionado este dispositivo:"
        Write-Host "   ğŸ’» $env:TAILSCALE_HOSTNAME"
        Write-Host "3. Selecciona 'Use as Exit Node'"
        Write-Host "4. Â¡Todo tu trÃ¡fico pasarÃ¡ por esta VPN!"
        Write-Host ""
        Write-Host "ğŸ›œ IP del servidor VPN: $env:TAILSCALE_IP"
        Write-Host "â° Esta VPN estarÃ¡ activa por 10 MINUTOS"
        Write-Host "ğŸ›‘ Se apagarÃ¡ automÃ¡ticamente a los 10 minutos"
        Write-Host "=========================="
        Write-Host ""
        
        # Mantener el servicio activo por EXACTAMENTE 10 minutos
        $startTime = Get-Date
        $duration = New-TimeSpan -Minutes 10
        $endTime = $startTime + $duration
        
        while ((Get-Date) -lt $endTime) {
            $remaining = $endTime - (Get-Date)
            $minutesRemaining = [math]::Round($remaining.TotalMinutes, 1)
            
            Write-Host "[$(Get-Date)] VPN activa - Tiempo restante: $minutesRemaining minutos - IP: $env:TAILSCALE_IP"
            
            # Verificar que Tailscale siga funcionando
            $status = & "$env:ProgramFiles\Tailscale\tailscale.exe" status
            if ($LASTEXITCODE -ne 0) {
                Write-Host "âŒ Error: Tailscale desconectado"
                exit 1
            }
            
            # Esperar 30 segundos
            Start-Sleep -Seconds 30
        }
        
        Write-Host ""
        Write-Host "â° ===== TIEMPO COMPLETADO ====="
        Write-Host "ğŸ›‘ VPN apagÃ¡ndose automÃ¡ticamente"
        Write-Host "âœ… Los 10 minutos han terminado"
        Write-Host "================================"
